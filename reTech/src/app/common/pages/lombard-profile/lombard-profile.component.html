<div class="container-fluid mt-3">
  <div class="row justify-content-center">
    <!-- Top Section -->
    <div class="col-12">
      <div class="profile-header d-flex align-items-center p-3 mb-3" *ngIf="profile$ | async as profile; else notLoggedIn">
        <!-- Pawnshop Logo -->
        <div class="avatar-img">
          <img [src]="profile?.logoUrl || 'assets/png/default-pawnshop.jpg'"
               alt="pawnshop-logo"
               class="rounded-circle me-3"
               width="190"
               height="190" />
               
          <!-- <div class="avatar-overlay" [class.show]="hover" (click)="changeProfilePhoto()">
            <span>Изменить фото профиля</span>
          </div> -->
        </div>

        <!-- Pawnshop Info -->
        <div class="flex-grow-1 ms-5" *ngIf="profile">
          <h3 class="mb-1">{{ profile?.name || 'Pawnshop name' }}</h3>
          <!-- <p class="text-muted mb-2">{{ profile?.description || 'Pawnshop description' }}</p> -->
          <div class="d-flex gap-3 mt-3">
            <p class="text-muted mb-1 small fw-semibold">
              <i class="fa-regular fa-clock me-1"></i>
              {{ profile?.openTime }} – {{ profile?.closeTime }}
              <span
                [ngClass]="{
                  'text-success': isOpenNow,
                  'text-danger': !isOpenNow
                }"
                class="ms-2 fw-bold"
              >
                {{ isOpenNow ? 'Открыто' : 'Закрыто' }}
              </span>
            </p>
            <p class="text-muted mb-1 small fw-semibold">
              <i class="fa-regular fa-clock me-1"></i> {{ currentTime | date:'shortTime' }}
            </p>
            <!-- <p class="text-muted mb-0 small fw-semibold">
              <i class="fa-regular fa-envelope"></i> {{ profile?.email }}
            </p> -->
          </div>
        </div>


        <div class="d-flex gap-2 align-self-end">
          <button class="btn btn-lombard btn-lombard-edit" (click)="openEditLombard()">
            <i class="fa-solid fa-building me-2"></i>{{ 'Edit details of shop' | translate }}
          </button>
          <button class="btn btn-lombard btn-outline-primary" (click)="openEditModal()">
            <i class="fa-regular fa-pen-to-square me-1"></i>{{ 'Edit profile' | translate }}
          </button>
        </div>

      </div>

      <ng-template #notLoggedIn>
        <div class="alert alert-warning d-flex align-items-center p-4 mb-3" role="alert">
          <i class="fa-solid fa-profile-lock me-3 fs-4"></i>
          <div>
            <h5 class="mb-1 fw-bold">{{ 'You are not logged in' | translate }}</h5>
            <p class="mb-0">
              {{ 'Please' | translate }}
              <a routerLink="/login" class="text-primary fw-semibold">{{ 'log in' | translate }}</a>
              {{ 'or' | translate }}
              <a routerLink="/register" class="text-primary fw-semibold">{{ 'register' | translate }}</a>.
            </p>
          </div>
        </div>
      </ng-template>
    </div>

    <!-- Bottom Section -->
    <div class="col-12" *ngIf="profile$ | async as profile">
      <div class="profile-section d-flex gap-3">
  
        <div class="description-content p-4 shadow-sm rounded-3 bg-light position-relative">
  <!-- Кнопка редактирования -->
          <button
            class="edit-icon position-absolute top-0 end-0 m-3 btn btn-light border-0"
            title="Edit description"
            (click)="toggleEdit()"
          >
            <i class="far fa-edit"></i>
          </button>

          <!-- Заголовок -->
          <div class="d-flex align-items-center mb-3">
            <i class="fa-solid fa-circle-info text-primary me-2 fs-5"></i>
            <h4 class="m-0 fw-semibold">{{ "Description" | translate }}</h4>
          </div>

          <!-- Текст / Поле редактирования -->
          <div class="description-text">
            <!-- Если редактирование включено -->
            <div *ngIf="isEditing; else viewMode">
              <textarea
                class="form-control"
                [(ngModel)]="editableDescription"
                rows="6"
                placeholder="{{ 'Enter description...' | translate }}"
              ></textarea>

              <div class="mt-2 d-flex justify-content-end gap-2">
                <button class="btn btn-sm btn-secondary" (click)="cancelEdit()">
                  {{ 'Cancel' | translate }}
                </button>
                <button class="btn btn-sm btn-success" (click)="saveDescription()">
                  {{ 'Save' | translate }}
                </button>
              </div>
            </div>

            <!-- Если просто просмотр -->
            <ng-template #viewMode>
              <span *ngIf="profile?.description; else noDescription">
                {{ profile.description }}
              </span>
              <ng-template #noDescription>
                <span class="text-muted fst-italic">
                  {{ "No description provided yet." | translate }}
                </span>
              </ng-template>
            </ng-template>
          </div>
        </div>


     
        <div class="pawnshop-stats p-4 shadow-sm bg-white rounded">
          <div class="d-flex align-items-center mb-3">
            <i class="fa-solid fa-chart-simple text-success me-2 fs-5"></i>
            <h4 class="m-0 fw-semibold">{{ "Pawnshop summary" | translate }}</h4>
          </div>

          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-value">{{ (profile$ | async)?.activeSlots?.length || 0 }}</span>
              <span class="stat-label">{{ "Active slots" | translate }}</span>
            </div>

            <div class="stat-item">
              <span class="stat-value">
                {{ (products$ | async)?.length || (products$ | async) || 0 }}
              </span>
              <span class="stat-label">{{ "Items for sale" | translate }}</span>
            </div>

            <div class="stat-item" (click)="scrollToTableItem()" style="cursor: pointer;">
              <span class="stat-value">{{ (products$ | async)?.length || 0 }}</span>
              <span class="stat-label">{{ "Total items" | translate }}</span>
            </div>

            <div class="stat-item">
              <span class="stat-value">
                {{ computeSlotUsagePercent(profile$ | async, products$ | async) }}%
              </span>
              <span class="stat-label">{{ "Slot usage" | translate }}</span>
            </div>
          </div>
        </div>

        <!-- Правая колонка -->
        <div class="extra-content">
          <div class="small-block text-center">
            <i class="fa-solid fa-star text-warning fs-4 mb-2"></i>
            <h6 class="fw-semibold mb-3">{{ 'Rating and reviews' | translate }}</h6>

            <!-- Средний рейтинг -->
            <div class="mb-3">
              <span class="fs-5 fw-bold text-dark">4.8</span>
              <span class="text-muted small">/ 5.0</span>
              <div class="stars text-warning mt-1">
                ★★★★☆
              </div>
            </div>

            <!-- Фейковые отзывы -->
            <div class="reviews text-start px-3">
              <div class="review mb-2">
                <p class="mb-1 fw-semibold">Aruzhan K.</p>
                <p class="text-muted small fst-italic">
                  “Fast service and fair prices. Highly recommend!”
                </p>
              </div>

              <div class="review mb-2">
                <p class="mb-1 fw-semibold">Dias M.</p>
                <p class="text-muted small fst-italic">
                  “Staff were helpful, got a good deal for my phone.”
                </p>
              </div>

              <div class="review">
                <p class="mb-1 fw-semibold">Elena T.</p>
                <p class="text-muted small fst-italic">
                  “Clean place and trustworthy staff.”
                </p>
              </div>
            </div>
          </div>
        </div>
        
      </div>
    </div>

    <!--Это таблица список продуктов кампании-->
    <div  #itemsTable id="itemsTable" class="items-list mt-4 shadow-sm rounded bg-white p-3" *ngIf="profile$ && products$ | async">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-semibold mb-0">
          <i class="fa-solid fa-box me-2 text-primary"></i>
          {{ 'Items list' | translate }}
        </h4>

        <button class="btn btn-lombard btn-success" (click)="openAddOfferModal()">
          <i class="fa-solid fa-plus me-1"></i>{{ 'Add item' | translate }}
        </button>
      </div>

      <div *ngIf="products$ | async; else noItems">
        <div class="table-responsive">
          <table class="table align-middle table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>{{ 'Photo' | translate }}</th>
                <th>{{ 'Title' | translate }}</th>
                <th>{{ 'Category' | translate }}</th>
                <th>{{ 'Price' | translate }}</th>
                <th>{{ 'Status' | translate }}</th>
                <th>{{ 'Created' | translate }}</th>
                <th>{{ 'Action' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of products$ | async">
                <td>
                  <img
                    [src]="item.photos?.[0] || 'assets/png/default-product.png'"
                    alt="{{ item.title }}"
                    class="item-photo rounded"
                    width="60"
                    height="60"
                  />
                </td>
                <td class="fw-semibold">{{ item.title }}</td>
                <td>{{ item.category }}</td>
                <td class="text-success fw-bold">${{ item.price }}</td>
                <td>
                  <span
                    class="badge"
                    [ngClass]="{
                      'bg-success': item.status === 'sold',
                      'bg-warning text-dark': item.status === 'active',
                      'bg-secondary': item.status === 'closed'
                    }"
                  >
                    {{ item.status | titlecase }}
                  </span>
                </td>
                <td>{{ item.createdAt | date: 'short' }}</td>
                <td>
                  <button 
                      class="btn btn-sm me-2" 
                      (click)="editProduct(item)"
                      ngbTooltip="{{ 'Edit product' | translate }}"
                      container="body">
                    <i class="fa-solid fa-pen"></i>
                  </button>
                  <button 
                      class="btn btn-sm"
                      (click)="deleteProduct()"
                      ngbTooltip="{{ 'Delete product' | translate }}"
                      container="body">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                  <button 
                      class="btn btn-sm" 
                      (click)="openProductDetail(item)"
                      ngbTooltip="{{ 'View details' | translate }}"
                      container="body">
                    <i class="fa-solid fa-file-lines"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <ng-template #noItems>
        <div class="alert alert-info text-center m-0">
          {{ 'No items found for this pawnshop.' | translate }}
        </div>
      </ng-template>
    </div>

    <div class="active-slots mt-5" *ngIf="slotsWithProducts$ | async; else noActiveSlots">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-semibold mb-0">
          <i class="fa-solid fa-hand-holding-dollar text-success me-2"></i>
          {{ 'Active slots' | translate }}
        </h4>

        <button class="btn btn-lombard btn-warning" (click)="openCreateSlotModal()">
          <i class="fa-solid fa-vault me-1"></i>{{ 'Create slot' | translate }}
        </button>
      </div>

      <div class="row g-3">
        <div class="col-md-4" *ngFor="let item of slotsWithProducts$ | async">
          <div class="card shadow-sm border-success h-100 position-relative">
            <div class="card-body d-flex flex-column">

              <!-- Верхняя часть -->
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="d-flex align-items-center">
                  <img
                    [src]="item.product?.photos?.[0] || 'assets/png/default-product.png'"
                    alt="{{ item.product?.title }}"
                    class="rounded me-3"
                    style="object-fit: cover;"
                    width="60"
                    height="60"
                  />
                  <div>
                    <h6 class="mb-1 fw-bold">{{ item.product?.title }}</h6>
                    <span class="badge bg-success">{{ item.slot.status | titlecase }}</span>
                  </div>
                </div>

                <!-- Меню действий -->
                <div class="dropdown">
                  <button
                    class="btn btn-link text-muted p-0"
                    type="button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <i class="fa-solid fa-ellipsis-vertical fs-5"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <button class="dropdown-item" (click)="openSlotDetails(item.slot)">
                        {{ 'Details' | translate }}
                      </button>
                    </li>
                    <li>
                      <button class="dropdown-item" (click)="editSlot(item.slot)">
                        {{ 'Edit' | translate }}
                      </button>
                    </li>
                    <li>
                      <button class="dropdown-item text-danger" (click)="deleteSlot(item.slot._id)">
                        {{ 'Delete' | translate }}
                      </button>
                    </li>
                  </ul>
                </div>
              </div>

              <!-- Данные по слоту -->
              <div class="flex-grow-1">
                <p class="mb-1"><strong>{{ 'Loan amount' | translate }}:</strong> ${{ item.slot.loanAmount }}</p>
                <p class="mb-1"><strong>{{ 'Interest rate' | translate }}:</strong> {{ item.slot.interestRate }}%</p>
                <p class="mb-1"><strong>{{ 'End date' | translate }}:</strong> {{ item.slot.endDate | date:'shortDate' }}</p>
              </div>

              <!-- Нижняя часть -->
              <div class="mt-3 text-muted small d-flex justify-content-end">
                {{ item.slot.createdAt | date:'short' }}
              </div>

            </div>
          </div>
        </div>
      </div>


    </div>



    <ng-template #noActiveSlots>
      <div class="alert alert-secondary mt-3 text-center">
        {{ 'No active slots at the moment' | translate }}
      </div>
    </ng-template>

  </div>
</div>
